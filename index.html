<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de FiscalizaciÃ³n - IB2026</title>
    <style>
        :root {
            /* Paleta de Colores VERDOSOS */
            --primary: #196F3D;    /* Verde Institucional Fuerte */
            --secondary: #2ECC71;  /* Verde Esmeralda */
            --accent: #145A32;     /* Verde Bosque Oscuro */
            --bg: #E8F5E9;         /* Fondo Verde Muy Claro */
            --white: #ffffff;
            --text: #2c3e50;
            --admin-badge: #D4AC0D; /* Dorado para Admin */
            --user-badge: #27ae60;  /* Verde para Usuario */
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }

        /* --- LOGIN / REGISTRO --- */
        .auth-container {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: linear-gradient(135deg, var(--accent), var(--primary));
        }
        .auth-box {
            background: var(--white); padding: 40px; border-radius: 10px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 350px; text-align: center;
            border-top: 5px solid var(--secondary);
        }
        .auth-box h2 { color: var(--primary); margin-bottom: 20px; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        
        input, select, textarea { 
            width: 100%; padding: 10px; border: 1px solid #A9DFBF; 
            border-radius: 4px; box-sizing: border-box; background-color: #FAFDFB; font-family: inherit;
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }
        
        button { 
            width: 100%; padding: 10px; border: none; border-radius: 4px; 
            cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; 
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--accent); }
        .btn-link { background: none; color: var(--primary); text-decoration: underline; margin-top: 15px; font-size: 12px; }

        /* --- APP PRINCIPAL --- */
        #app { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--white); padding: 20px; border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-bottom: 4px solid var(--primary);
        }

        .user-badge { padding: 5px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; color: white; }
        .role-admin { background-color: var(--admin-badge); }
        .role-user { background-color: var(--user-badge); }

        /* Panel Admin */
        #adminPanel {
            display: none; background: #D5F5E3; border: 1px solid #A9DFBF;
            padding: 20px; margin-top: 20px; border-radius: 8px;
        }
        .panel-title { color: var(--accent); font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #A9DFBF; padding-bottom: 5px; }

        /* Layout del Formulario Masivo */
        .form-massive { display: flex; gap: 20px; align-items: flex-start; }
        .form-col-text { flex: 2; }
        .form-col-actions { flex: 1; display: flex; flex-direction: column; gap: 10px; }

        /* Tabla General */
        .table-container { 
            margin-top: 30px; background: var(--white); padding: 20px; 
            border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; 
        }
        h3 { margin-top: 0; color: var(--primary); border-left: 5px solid var(--secondary); padding-left: 10px; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px; }
        th { background-color: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background-color: #EAFAF1; }

        /* Tabla EstadÃ­sticas */
        .stats-table th { background-color: var(--accent); }
        .stats-table td { text-align: center; }
        .stats-table td:first-child { text-align: left; font-weight: bold; }

        /* Botones AcciÃ³n */
        .btn-action { padding: 6px 12px; font-size: 11px; width: auto; margin: 0; }
        .btn-entregar { background-color: #E67E22; color: white; } 
        .btn-recibir { background-color: #8E44AD; color: white; } 
        
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .st-asignado { background-color: #E74C3C; } 
        .st-entregado { background-color: #F1C40F; } 
        .st-finalizado { background-color: var(--secondary); }

    </style>
</head>
<body>

    <div id="loginScreen" class="auth-container">
        <div class="auth-box">
            <h2>GestiÃ³n FiscalizaciÃ³n</h2>
            <div class="input-group">
                <label>Usuario</label>
                <input type="text" id="loginUser" placeholder="Ej. Jaguar">
            </div>
            <div class="input-group">
                <label>ContraseÃ±a</label>
                <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button class="btn-primary" onclick="login()">Iniciar SesiÃ³n</button>
            <button class="btn-link" onclick="toggleScreens('register')">Crear cuenta de Auditor</button>
        </div>
    </div>

    <div id="registerScreen" class="auth-container" style="display: none;">
        <div class="auth-box">
            <h2>Nuevo Auditor</h2>
            <div class="input-group">
                <label>Nombre Completo</label>
                <input type="text" id="regName" placeholder="Nombre y Apellido">
            </div>
            <div class="input-group">
                <label>Usuario (MÃ¡x 8 letras)</label>
                <input type="text" id="regUser" maxlength="8" placeholder="Ej. juanp">
            </div>
            <div class="input-group">
                <label>ContraseÃ±a</label>
                <input type="password" id="regPass">
            </div>
            <button class="btn-primary" onclick="register()">Registrarse</button>
            <button class="btn-link" onclick="toggleScreens('login')">Volver al Login</button>
        </div>
    </div>

    <div id="app">
        <header>
            <div>
                <h2 style="margin:0; color:var(--primary);">Control Documental 2026</h2>
                <div style="margin-top:5px;">
                    Bienvenido, <span id="displayUserName" style="font-weight:bold;"></span> 
                    <span id="roleBadge" class="user-badge"></span>
                </div>
            </div>
            <button onclick="logout()" style="width: auto; background: #C0392B; color: white;">Salir</button>
        </header>

        <div id="adminPanel">
            <div class="panel-title">ðŸŒ¿ ASIGNACIÃ“N MASIVA DE OFICIOS</div>
            <div class="form-massive">
                <div class="form-col-text">
                    <label style="font-weight:bold; color:var(--accent);">Pegar lista de Oficios:</label>
                    <textarea id="oficioInput" rows="4" placeholder="Ejemplo:&#10;OFI-001/2026&#10;OFI-002/2026&#10;OFI-003/2026&#10;(Puedes pegar desde Excel o separar por comas)"></textarea>
                    <small style="color:#666;">* Cada lÃ­nea cuenta como un registro nuevo.</small>
                </div>
                <div class="form-col-actions">
                    <label style="font-weight:bold; color:var(--accent);">Asignar a:</label>
                    <select id="userSelect"></select>
                    <button class="btn-primary" onclick="asignarOficiosMasivo()">ASIGNAR TODO</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <h3>BitÃ¡cora de Movimientos</h3>
            <table>
                <thead>
                    <tr>
                        <th>Oficio</th>
                        <th>Auditor Asignado</th>
                        <th>Asignado Por</th>
                        <th>Estatus de Fechas</th>
                        <th>AcciÃ³n</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="documentTableBody"></tbody>
            </table>
        </div>

        <div class="table-container" style="background-color: #F8F9F9; border-top: 3px solid var(--accent);">
            <h3>ðŸ“Š Resumen de Cargas de Trabajo</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Usuario / Auditor</th>
                        <th>ðŸ”´ Pendientes (Asignados)</th>
                        <th>ðŸŸ¡ En RevisiÃ³n (Entregados)</th>
                        <th>ðŸŸ¢ Finalizados (Cerrados)</th>
                        <th>Total Oficios</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody">
                    </tbody>
            </table>
        </div>

    </div>

<script>
    // --- BASE DE DATOS LOCAL ---
    const DB_USERS = 'db_fiscal_green_users';
    const DB_DOCS = 'db_fiscal_green_docs';
    let currentUser = null;

    // 1. INICIALIZACIÃ“N DE ADMINS
    let users = JSON.parse(localStorage.getItem(DB_USERS)) || [];
    const adminsPredefinidos = [
        { name: "Administrador Jaguar", username: "Jaguar", password: "Verde2026", role: "admin" },
        { name: "Administrador Aguila", username: "Aguila", password: "Lima2026", role: "admin" },
        { name: "Administrador Tigre",  username: "Tigre",  password: "Menta2026", role: "admin" }
    ];

    adminsPredefinidos.forEach(admin => {
        if (!users.find(u => u.username === admin.username)) {
            users.push(admin);
        }
    });
    localStorage.setItem(DB_USERS, JSON.stringify(users)); 

    let docs = JSON.parse(localStorage.getItem(DB_DOCS)) || [];

    // --- FUNCIONES DE ACCESO ---
    function toggleScreens(screen) {
        document.getElementById('loginScreen').style.display = screen === 'login' ? 'flex' : 'none';
        document.getElementById('registerScreen').style.display = screen === 'register' ? 'flex' : 'none';
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    function register() {
        const name = document.getElementById('regName').value.trim();
        const user = document.getElementById('regUser').value.trim();
        const pass = document.getElementById('regPass').value.trim();

        if (!name || !user || !pass) return alert("Complete todos los campos.");
        if (users.find(u => u.username === user)) return alert("Error: El usuario ya existe.");

        // RESTRICCIÃ“N: MÃXIMO 3 USUARIOS CON EL MISMO NOMBRE
        const personasConMismoNombre = users.filter(u => u.name.toLowerCase() === name.toLowerCase());
        if (personasConMismoNombre.length >= 3) {
            return alert("Â¡Alerta! LÃ­mite de 3 usuarios alcanzado para el nombre: " + name);
        }

        users.push({ name, username: user, password: pass, role: 'user' });
        localStorage.setItem(DB_USERS, JSON.stringify(users));
        alert("Registro exitoso.");
        toggleScreens('login');
    }

    function login() {
        const userIn = document.getElementById('loginUser').value.trim();
        const passIn = document.getElementById('loginPass').value.trim();
        const foundUser = users.find(u => u.username === userIn && u.password === passIn);

        if (foundUser) {
            currentUser = foundUser;
            initApp();
        } else {
            alert("Credenciales incorrectas.");
        }
    }

    function logout() {
        currentUser = null;
        document.getElementById('app').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    // --- LÃ“GICA DEL SISTEMA ---
    function initApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';

        document.getElementById('displayUserName').textContent = currentUser.name;
        const badge = document.getElementById('roleBadge');
        badge.textContent = currentUser.role === 'admin' ? "ADMINISTRADOR" : "AUDITOR";
        badge.className = `user-badge ${currentUser.role === 'admin' ? 'role-admin' : 'role-user'}`;

        if (currentUser.role === 'admin') {
            document.getElementById('adminPanel').style.display = 'block';
            cargarUsuariosSelect();
        } else {
            document.getElementById('adminPanel').style.display = 'none';
        }

        renderTable();
        renderStats(); // Renderizar estadÃ­sticas al entrar
    }

    function cargarUsuariosSelect() {
        const select = document.getElementById('userSelect');
        select.innerHTML = '<option value="">Seleccione Auditor...</option>';
        const auditores = users.filter(u => u.role === 'user');
        auditores.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.username;
            opt.textContent = `${u.name} (${u.username})`;
            select.appendChild(opt);
        });
    }

    // --- REGISTRO MASIVO ---
    function asignarOficiosMasivo() {
        const textoOficios = document.getElementById('oficioInput').value;
        const asignadoA = document.getElementById('userSelect').value;

        if (!textoOficios.trim() || !asignadoA) return alert("Ingrese al menos un oficio y seleccione un usuario.");

        // Separar por saltos de lÃ­nea (\n) o comas
        const listaOficios = textoOficios.split(/[\n,]+/).map(item => item.trim()).filter(item => item !== "");

        if(listaOficios.length === 0) return alert("No se detectaron oficios validos.");

        let contador = 0;
        listaOficios.forEach(oficio => {
            const nuevoDoc = {
                id: Date.now() + Math.random(), // ID Ãºnico
                oficio: oficio,
                asignadoA: asignadoA, 
                asignadoPor: currentUser.username, 
                fechaAsignacion: new Date().toLocaleString(),
                fechaEntrega: null,
                fechaRecepcion: null,
                estado: 'asignado' 
            };
            docs.push(nuevoDoc);
            contador++;
        });

        guardarYRenderizar();
        document.getElementById('oficioInput').value = ''; // Limpiar campo
        alert(`âœ… Se registraron ${contador} oficios exitosamente para el usuario ${asignadoA}.`);
    }

    // --- ACCIONES INDIVIDUALES ---
    function registrarEntrega(id) {
        const doc = docs.find(d => d.id === id);
        if (doc.asignadoA !== currentUser.username) return alert("No puedes entregar este oficio.");
        doc.fechaEntrega = new Date().toLocaleString();
        doc.estado = 'entregado';
        guardarYRenderizar();
    }

    function registrarRecepcion(id) {
        if (currentUser.role !== 'admin') return alert("Acceso denegado.");
        const doc = docs.find(d => d.id === id);
        doc.fechaRecepcion = new Date().toLocaleString();
        doc.estado = 'finalizado';
        guardarYRenderizar();
    }

    function guardarYRenderizar() {
        localStorage.setItem(DB_DOCS, JSON.stringify(docs));
        renderTable();
        renderStats(); // Actualizar estadÃ­sticas tras cambios
    }

    function renderTable() {
        const tbody = document.getElementById('documentTableBody');
        tbody.innerHTML = '';
        const lista = docs.slice().reverse();

        lista.forEach(doc => {
            let accionBtn = '-';
            let estadoHTML = '';

            if (doc.estado === 'asignado') {
                estadoHTML = '<span class="status-dot st-asignado"></span>Pendiente Entrega';
                if (currentUser.username === doc.asignadoA) {
                    accionBtn = `<button class="btn-action btn-entregar" onclick="registrarEntrega(${doc.id})">REGISTRAR ENTREGA</button>`;
                } else {
                    accionBtn = `<small style="color:#999">Esperando al auditor...</small>`;
                }
            } 
            else if (doc.estado === 'entregado') {
                estadoHTML = '<span class="status-dot st-entregado"></span>Entregado (Por Validar)';
                if (currentUser.role === 'admin') {
                    accionBtn = `<button class="btn-action btn-recibir" onclick="registrarRecepcion(${doc.id})">VALIDAR RECEPCIÃ“N</button>`;
                } else {
                    accionBtn = `<small style="color:#E67E22">Esperando revisiÃ³n Admin...</small>`;
                }
            } 
            else {
                estadoHTML = '<span class="status-dot st-finalizado"></span>Ciclo Cerrado';
                accionBtn = '<strong style="color:var(--primary)">âœ” Completado</strong>';
            }

            const fila = `
                <tr>
                    <td><strong>${doc.oficio}</strong></td>
                    <td>${doc.asignadoA}</td>
                    <td><small>${doc.asignadoPor}</small></td>
                    <td style="font-size:11px; line-height:1.4;">
                        <div>ðŸ“… Asig: ${doc.fechaAsignacion}</div>
                        <div style="color:#E67E22">${doc.fechaEntrega ? 'ðŸ“¦ Entr: ' + doc.fechaEntrega : ''}</div>
                        <div style="color:#8E44AD">${doc.fechaRecepcion ? 'âœ… Recp: ' + doc.fechaRecepcion : ''}</div>
                    </td>
                    <td>${accionBtn}</td>
                    <td>${estadoHTML}</td>
                </tr>
            `;
            tbody.innerHTML += fila;
        });
    }

    // --- NUEVA FUNCIÃ“N: RENDERIZAR ESTADÃSTICAS ---
    function renderStats() {
        const tbody = document.getElementById('statsTableBody');
        tbody.innerHTML = '';

        // Filtrar solo usuarios normales
        const auditores = users.filter(u => u.role === 'user');

        auditores.forEach(user => {
            // Contar documentos por estado para este usuario
            const misDocs = docs.filter(d => d.asignadoA === user.username);
            const pendientes = misDocs.filter(d => d.estado === 'asignado').length;
            const entregados = misDocs.filter(d => d.estado === 'entregado').length;
            const finalizados = misDocs.filter(d => d.estado === 'finalizado').length;
            const total = misDocs.length;

            if (total > 0) { // Solo mostrar si tiene actividad
                const fila = `
                    <tr>
                        <td>${user.name} <br><small style="color:#777">(${user.username})</small></td>
                        <td style="color:#E74C3C; font-weight:bold;">${pendientes}</td>
                        <td style="color:#F1C40F; font-weight:bold;">${entregados}</td>
                        <td style="color:var(--primary); font-weight:bold;">${finalizados}</td>
                        <td><strong>${total}</strong></td>
                    </tr>
                `;
                tbody.innerHTML += fila;
            }
        });

        if (tbody.innerHTML === '') {
            tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; color:#999;">No hay actividad registrada aÃºn.</td></tr>';
        }
    }
</script>

</body>
</html>
