<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fiscalizaci√≥n - IB2026</title>
    <style>
        :root {
            --primary: #196F3D;    
            --secondary: #2ECC71;  
            --accent: #145A32;     
            --bg: #E8F5E9;         
            --white: #ffffff;
            --text: #2c3e50;
            --admin-badge: #D4AC0D; 
            --user-badge: #27ae60;  
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }

        /* --- LOGIN / REGISTRO --- */
        .auth-container {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: linear-gradient(135deg, var(--accent), var(--primary));
        }
        .auth-box {
            background: var(--white); padding: 40px; border-radius: 10px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 350px; text-align: center;
            border-top: 5px solid var(--secondary);
        }
        .auth-box h2 { color: var(--primary); margin-bottom: 20px; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        
        input, select, textarea { 
            width: 100%; padding: 10px; border: 1px solid #A9DFBF; 
            border-radius: 4px; box-sizing: border-box; background-color: #FAFDFB; font-family: inherit;
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }
        
        button { 
            width: 100%; padding: 10px; border: none; border-radius: 4px; 
            cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; 
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--accent); }
        .btn-link { background: none; color: var(--primary); text-decoration: underline; margin-top: 15px; font-size: 12px; }

        /* --- APP PRINCIPAL --- */
        #app { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--white); padding: 20px; border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-bottom: 4px solid var(--primary);
        }

        .user-badge { padding: 5px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; color: white; }
        .role-admin { background-color: var(--admin-badge); }
        .role-user { background-color: var(--user-badge); }

        #adminPanel {
            display: none; background: #D5F5E3; border: 1px solid #A9DFBF;
            padding: 20px; margin-top: 20px; border-radius: 8px;
        }
        .panel-title { color: var(--accent); font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #A9DFBF; padding-bottom: 5px; }

        .form-massive { display: flex; gap: 20px; align-items: flex-start; }
        .form-col-text { flex: 2; }
        .form-col-actions { flex: 1; display: flex; flex-direction: column; gap: 10px; }

        /* TABLAS */
        .table-container { 
            margin-top: 30px; background: var(--white); padding: 20px; 
            border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; 
        }
        h3 { margin-top: 0; color: var(--primary); border-left: 5px solid var(--secondary); padding-left: 10px; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px; }
        th { background-color: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background-color: #EAFAF1; }

        .btn-action { padding: 6px 12px; font-size: 11px; width: auto; margin: 0; }
        .btn-entregar { background-color: #E67E22; color: white; } 
        .btn-recibir { background-color: #8E44AD; color: white; } 
        .btn-delete { background-color: #c0392b; color: white; border-radius: 50%; width: 30px; height: 30px; padding: 0; line-height: 30px; text-align: center; }
        
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .st-asignado { background-color: #E74C3C; } 
        .st-entregado { background-color: #F1C40F; } 
        .st-finalizado { background-color: var(--secondary); }

        /* --- MODAL ESTAD√çSTICAS --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; width: 600px; padding: 30px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .chart-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .tab-btn { background: #eee; color: #555; padding: 8px 16px; border-radius: 20px; font-size: 12px; width: auto; margin: 0; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        /* Gr√°fico de Barras CSS Simple */
        .chart-container { height: 300px; display: flex; align-items: flex-end; justify-content: space-around; padding-top: 20px; background: #fafafa; border: 1px solid #eee; border-radius: 4px; }
        .bar-group { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .bar { width: 40px; background: var(--secondary); border-radius: 4px 4px 0 0; transition: height 0.5s; position: relative; }
        .bar:hover { background: var(--primary); }
        .bar-value { position: absolute; top: -20px; width: 100%; text-align: center; font-weight: bold; font-size: 12px; }
        .bar-label { margin-top: 10px; font-size: 11px; text-align: center; color: #555; font-weight: bold; }
        .no-data { width: 100%; text-align: center; color: #999; margin-top: 100px; }

    </style>
</head>
<body>

    <div id="statsModal" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; color:var(--primary);">üìä Productividad de Entrega</h2>
                <button onclick="cerrarEstadisticas()" style="width:auto; background:none; color:#999; font-size:20px; margin:0;">‚úñ</button>
            </div>

            <div class="chart-tabs">
                <button class="tab-btn active" onclick="cambiarPeriodo('dia', this)">Hoy (D√≠a)</button>
                <button class="tab-btn" onclick="cambiarPeriodo('semana', this)">Esta Semana</button>
                <button class="tab-btn" onclick="cambiarPeriodo('mes', this)">Este Mes</button>
            </div>

            <div id="graficoArea" class="chart-container">
                </div>
            <p style="text-align:center; font-size:12px; color:#777; margin-top:15px;">Muestra conteo de oficios con estatus "Entregado" o "Finalizado".</p>
        </div>
    </div>

    <div id="loginScreen" class="auth-container">
        <div class="auth-box">
            <h2>Gesti√≥n Fiscalizaci√≥n</h2>
            <div class="input-group">
                <label>Usuario</label>
                <input type="text" id="loginUser" placeholder="Ej. Jaguar">
            </div>
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn-primary" onclick="login()">Iniciar Sesi√≥n</button>
            <button class="btn-link" onclick="toggleScreens('register')">Crear cuenta de Auditor</button>
        </div>
    </div>

    <div id="registerScreen" class="auth-container" style="display: none;">
        <div class="auth-box">
            <h2>Nuevo Auditor</h2>
            <div class="input-group">
                <label>Nombre Completo</label>
                <input type="text" id="regName" placeholder="Nombre y Apellido">
            </div>
            <div class="input-group">
                <label>Usuario (M√°x 8 letras)</label>
                <input type="text" id="regUser" maxlength="8" placeholder="Ej. juanp">
            </div>
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="regPass">
            </div>
            <button class="btn-primary" onclick="register()">Registrarse</button>
            <button class="btn-link" onclick="toggleScreens('login')">Volver al Login</button>
        </div>
    </div>

    <div id="app">
        <header>
            <div>
                <h2 style="margin:0; color:var(--primary);">Control Documental 2026</h2>
                <div style="margin-top:5px;">
                    Bienvenido, <span id="displayUserName" style="font-weight:bold;"></span> 
                    <span id="roleBadge" class="user-badge"></span>
                </div>
            </div>
            <button onclick="logout()" style="width: auto; background: #C0392B; color: white;">Salir</button>
        </header>

        <div id="adminPanel">
            <div class="panel-title">üåø ASIGNACI√ìN MASIVA</div>
            <div class="form-massive">
                <div class="form-col-text">
                    <label style="font-weight:bold; color:var(--accent);">Pegar lista de Oficios:</label>
                    <textarea id="oficioInput" rows="4" placeholder="Ej:&#10;OFI-001/2026&#10;OFI-002/2026"></textarea>
                </div>
                <div class="form-col-actions">
                    <label style="font-weight:bold; color:var(--accent);">Asignar a:</label>
                    <select id="userSelect"></select>
                    <button class="btn-primary" onclick="asignarOficiosMasivo()">ASIGNAR TODO</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <h3>Bit√°cora de Movimientos</h3>
            <table>
                <thead>
                    <tr>
                        <th>Oficio</th>
                        <th>Auditor Asignado</th>
                        <th>Asignado Por</th>
                        <th>Estatus de Fechas</th>
                        <th>Acci√≥n</th>
                        <th>Estado</th>
                        <th id="colDelete" style="display:none; text-align:center;">Eliminar</th>
                    </tr>
                </thead>
                <tbody id="documentTableBody"></tbody>
            </table>
        </div>

        <div class="table-container" style="background-color: #F8F9F9; border-top: 3px solid var(--accent);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>üìä Resumen de Cargas de Trabajo</h3>
                <button onclick="abrirEstadisticas()" style="width:auto; margin:0; background:var(--primary);">üìä VER ESTAD√çSTICAS</button>
            </div>
            
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Usuario / Auditor</th>
                        <th>üî¥ Pendientes</th>
                        <th>üü° En Revisi√≥n</th>
                        <th>üü¢ Finalizados</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody"></tbody>
            </table>
        </div>
    </div>

<script>
    // --- BD LOCAL ---
    const DB_USERS = 'db_fiscal_green_users';
    const DB_DOCS = 'db_fiscal_green_docs';
    let currentUser = null;

    // 1. DATA INICIAL
    let users = JSON.parse(localStorage.getItem(DB_USERS)) || [];
    const adminsPredefinidos = [
        { name: "Administrador Jaguar", username: "Jaguar", password: "Verde2026", role: "admin" },
        { name: "Administrador Aguila", username: "Aguila", password: "Lima2026", role: "admin" },
        { name: "Administrador Tigre",  username: "Tigre",  password: "Menta2026", role: "admin" }
    ];

    adminsPredefinidos.forEach(admin => {
        if (!users.find(u => u.username === admin.username)) users.push(admin);
    });
    localStorage.setItem(DB_USERS, JSON.stringify(users)); 

    let docs = JSON.parse(localStorage.getItem(DB_DOCS)) || [];

    // --- AUTH ---
    function toggleScreens(screen) {
        document.getElementById('loginScreen').style.display = screen === 'login' ? 'flex' : 'none';
        document.getElementById('registerScreen').style.display = screen === 'register' ? 'flex' : 'none';
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    function register() {
        const name = document.getElementById('regName').value.trim();
        const user = document.getElementById('regUser').value.trim();
        const pass = document.getElementById('regPass').value.trim();

        if (!name || !user || !pass) return alert("Complete todos los campos.");
        if (users.find(u => u.username === user)) return alert("Error: Usuario existente.");

        const countNames = users.filter(u => u.name.toLowerCase() === name.toLowerCase()).length;
        if (countNames >= 3) return alert("L√≠mite de 3 usuarios alcanzado para: " + name);

        users.push({ name, username: user, password: pass, role: 'user' });
        localStorage.setItem(DB_USERS, JSON.stringify(users));
        alert("Registro exitoso.");
        toggleScreens('login');
    }

    function login() {
        const userIn = document.getElementById('loginUser').value.trim();
        const passIn = document.getElementById('loginPass').value.trim();
        const foundUser = users.find(u => u.username === userIn && u.password === passIn);

        if (foundUser) {
            currentUser = foundUser;
            initApp();
        } else {
            alert("Credenciales incorrectas.");
        }
    }

    function logout() {
        currentUser = null;
        document.getElementById('app').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    // --- APP ---
    function initApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';

        document.getElementById('displayUserName').textContent = currentUser.name;
        const badge = document.getElementById('roleBadge');
        badge.textContent = currentUser.role === 'admin' ? "ADMINISTRADOR" : "AUDITOR";
        badge.className = `user-badge ${currentUser.role === 'admin' ? 'role-admin' : 'role-user'}`;

        // Mostrar Panel Asignaci√≥n (Admins)
        document.getElementById('adminPanel').style.display = currentUser.role === 'admin' ? 'block' : 'none';
        if (currentUser.role === 'admin') cargarUsuariosSelect();

        // Mostrar Columna Eliminar (Solo Jaguar)
        const colDelete = document.getElementById('colDelete');
        if (currentUser.username === 'Jaguar') {
            colDelete.style.display = 'table-cell';
        } else {
            colDelete.style.display = 'none';
        }

        renderTable();
        renderStatsTable();
    }

    function cargarUsuariosSelect() {
        const select = document.getElementById('userSelect');
        select.innerHTML = '<option value="">Seleccione Auditor...</option>';
        users.filter(u => u.role === 'user').forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.username;
            opt.textContent = `${u.name} (${u.username})`;
            select.appendChild(opt);
        });
    }

    // --- LOGICA NEGOCIO ---
    function asignarOficiosMasivo() {
        const textoOficios = document.getElementById('oficioInput').value;
        const asignadoA = document.getElementById('userSelect').value;

        if (!textoOficios.trim() || !asignadoA) return alert("Ingrese oficios y seleccione usuario.");

        const listaOficios = textoOficios.split(/[\n,]+/).map(item => item.trim()).filter(item => item !== "");
        if(listaOficios.length === 0) return alert("Oficios no v√°lidos.");

        let contador = 0;
        listaOficios.forEach(oficio => {
            docs.push({
                id: Date.now() + Math.random(),
                oficio: oficio,
                asignadoA: asignadoA, 
                asignadoPor: currentUser.username, 
                fechaAsignacion: new Date().toLocaleString(),
                fechaEntrega: null, fechaRecepcion: null, estado: 'asignado' 
            });
            contador++;
        });

        guardarYRenderizar();
        document.getElementById('oficioInput').value = ''; 
        alert(`‚úÖ ${contador} oficios asignados a ${asignadoA}.`);
    }

    function registrarEntrega(id) {
        const doc = docs.find(d => d.id === id);
        if (doc.asignadoA !== currentUser.username) return alert("No es tu oficio.");
        doc.fechaEntrega = new Date().toLocaleString();
        doc.estado = 'entregado';
        guardarYRenderizar();
    }

    function registrarRecepcion(id) {
        if (currentUser.role !== 'admin') return alert("Acceso denegado.");
        const doc = docs.find(d => d.id === id);
        doc.fechaRecepcion = new Date().toLocaleString();
        doc.estado = 'finalizado';
        guardarYRenderizar();
    }

    // --- BORRADO (SOLO JAGUAR) ---
    function eliminarRegistro(id) {
        if(currentUser.username !== 'Jaguar') return alert("Solo Jaguar puede eliminar.");
        
        if(confirm("¬øEst√°s seguro de ELIMINAR este registro permanentemente?")) {
            docs = docs.filter(d => d.id !== id);
            guardarYRenderizar();
        }
    }

    function guardarYRenderizar() {
        localStorage.setItem(DB_DOCS, JSON.stringify(docs));
        renderTable();
        renderStatsTable();
    }

    function renderTable() {
        const tbody = document.getElementById('documentTableBody');
        tbody.innerHTML = '';
        const lista = docs.slice().reverse();

        lista.forEach(doc => {
            let accionBtn = '-';
            let estadoHTML = '';
            let deleteCell = '';

            // Definir bot√≥n de acci√≥n
            if (doc.estado === 'asignado') {
                estadoHTML = '<span class="status-dot st-asignado"></span>Pendiente Entrega';
                accionBtn = currentUser.username === doc.asignadoA 
                    ? `<button class="btn-action btn-entregar" onclick="registrarEntrega(${doc.id})">REGISTRAR ENTREGA</button>` 
                    : `<small style="color:#999">Esperando...</small>`;
            } 
            else if (doc.estado === 'entregado') {
                estadoHTML = '<span class="status-dot st-entregado"></span>Entregado';
                accionBtn = currentUser.role === 'admin' 
                    ? `<button class="btn-action btn-recibir" onclick="registrarRecepcion(${doc.id})">VALIDAR</button>` 
                    : `<small style="color:#E67E22">Revisi√≥n...</small>`;
            } 
            else {
                estadoHTML = '<span class="status-dot st-finalizado"></span>Cerrado';
                accionBtn = '‚úî Listo';
            }

            // Celda Eliminar (Solo Jaguar)
            if (currentUser.username === 'Jaguar') {
                deleteCell = `<td style="text-align:center;"><button class="btn-delete" onclick="eliminarRegistro(${doc.id})">üóëÔ∏è</button></td>`;
            } else {
                deleteCell = `<td style="display:none;"></td>`;
            }

            const fila = `
                <tr>
                    <td><strong>${doc.oficio}</strong></td>
                    <td>${doc.asignadoA}</td>
                    <td><small>${doc.asignadoPor}</small></td>
                    <td style="font-size:11px;">
                        <div>üìÖ Asig: ${doc.fechaAsignacion}</div>
                        <div style="color:#E67E22">${doc.fechaEntrega ? 'üì¶ Entr: ' + doc.fechaEntrega : ''}</div>
                    </td>
                    <td>${accionBtn}</td>
                    <td>${estadoHTML}</td>
                    ${deleteCell}
                </tr>
            `;
            tbody.innerHTML += fila;
        });
    }

    function renderStatsTable() {
        const tbody = document.getElementById('statsTableBody');
        tbody.innerHTML = '';
        users.filter(u => u.role === 'user').forEach(user => {
            const misDocs = docs.filter(d => d.asignadoA === user.username);
            if (misDocs.length > 0) {
                const pen = misDocs.filter(d => d.estado === 'asignado').length;
                const rev = misDocs.filter(d => d.estado === 'entregado').length;
                const fin = misDocs.filter(d => d.estado === 'finalizado').length;
                tbody.innerHTML += `<tr><td>${user.name}</td><td style="color:#E74C3C;font-weight:bold">${pen}</td><td style="color:#F1C40F;font-weight:bold">${rev}</td><td style="color:var(--primary);font-weight:bold">${fin}</td><td><strong>${misDocs.length}</strong></td></tr>`;
            }
        });
    }

    // --- L√ìGICA GR√ÅFICO (MODAL) ---
    function abrirEstadisticas() {
        document.getElementById('statsModal').style.display = 'flex';
        renderGrafico('dia'); // Por defecto carga HOY
    }

    function cerrarEstadisticas() {
        document.getElementById('statsModal').style.display = 'none';
    }

    function cambiarPeriodo(periodo, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderGrafico(periodo);
    }

    function renderGrafico(periodo) {
        const container = document.getElementById('graficoArea');
        container.innerHTML = '';

        // 1. Obtener datos filtrados
        const hoy = new Date();
        const auditores = users.filter(u => u.role === 'user');
        let maxVal = 0;

        // Iterar usuarios para calcular altura barras
        const datosGrafico = auditores.map(user => {
            // Documentos entregados o finalizados por este usuario
            const entregados = docs.filter(d => {
                if (d.asignadoA !== user.username) return false;
                if (!d.fechaEntrega) return false; // Solo cuentan los que tienen fecha entrega

                // Parsear fecha entrega
                // Formato local es D/M/YYYY, HH:MM:SS (aprox)
                // Truco: Convertimos la fecha guardada en string a Objeto Date
                // Nota: Date.parse funciona bien con el formato local en navegadores modernos,
                // pero haremos una comparaci√≥n simple.
                
                // Extraer componentes de la fecha string del doc
                // Formato toLocaleString suele ser "D/M/AAAA, H:MM:SS" o similar
                // Para simplificar comparaciones usaremos strings de fecha
                
                // Mejor estrategia: Crear objeto fecha a partir del string si es posible, 
                // pero dado que el formato varia por PC, usaremos una l√≥gica simple de strings para "hoy"
                // y l√≥gica de tiempo para semana/mes.
                
                // Hack para compatibilidad: Reconstruir fecha
                // Como es localstorage en el mismo navegador, el formato es consistente.
                
                /* Intentamos convertir a objeto Date. Si falla, no cuenta */
                /* En Chrome/Edge toLocaleString se puede re-parsear new Date(string) muchas veces */
                /* Para robustez en este ejemplo, asumiremos que new Date(str) funciona */
                
                let fechaDoc = null;
                // Intentar parsear manualmente DD/MM/YYYY si falla el directo
                const partes = d.fechaEntrega.split(',')[0].split('/'); // "4/2/2026"
                if(partes.length === 3) {
                     // Asumiendo DD/MM/YYYY
                     fechaDoc = new Date(partes[2], partes[1]-1, partes[0]);
                } else {
                     fechaDoc = new Date(d.fechaEntrega);
                }

                if (isNaN(fechaDoc.getTime())) return false; // Fecha invalida

                // FILTROS
                if (periodo === 'dia') {
                    return fechaDoc.toDateString() === hoy.toDateString();
                } 
                else if (periodo === 'semana') {
                    // Mismo a√±o y misma semana
                    const onejan = new Date(hoy.getFullYear(), 0, 1);
                    const weekDoc = Math.ceil((((fechaDoc - onejan) / 86400000) + onejan.getDay() + 1) / 7);
                    const weekHoy = Math.ceil((((hoy - onejan) / 86400000) + onejan.getDay() + 1) / 7);
                    return (fechaDoc.getFullYear() === hoy.getFullYear()) && (weekDoc === weekHoy);
                } 
                else if (periodo === 'mes') {
                    return (fechaDoc.getMonth() === hoy.getMonth()) && (fechaDoc.getFullYear() === hoy.getFullYear());
                }
                return false;
            });

            const cantidad = entregados.length;
            if (cantidad > maxVal) maxVal = cantidad;

            return { nombre: user.username, cantidad: cantidad };
        });

        // 2. Dibujar Barras
        if (maxVal === 0) {
            container.innerHTML = '<div class="no-data">No hay entregas registradas en este periodo.</div>';
            return;
        }

        datosGrafico.forEach(dato => {
            if (dato.cantidad > 0 || datosGrafico.length < 10) { // Mostrar aunque sea 0 si hay pocos usuarios
                const porcentaje = (dato.cantidad / maxVal) * 80; // Max altura 80% del contenedor
                const htmlBarra = `
                    <div class="bar-group">
                        <div class="bar" style="height: ${porcentaje}%;">
                            <div class="bar-value">${dato.cantidad}</div>
                        </div>
                        <div class="bar-label">${dato.nombre}</div>
                    </div>
                `;
                container.innerHTML += htmlBarra;
            }
        });
    }

</script>
</body>
</html>
